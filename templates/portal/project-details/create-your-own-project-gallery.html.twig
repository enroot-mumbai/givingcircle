{% extends 'portal/layout/index.html.twig' %}
{% block portal_content %}
    {% set pageContentHeader = get_cms_page_content_by_slugname('create-project') %}
    <div class="modal fade common" id="tncpopup" tabindex="-1" aria-labelledby="demoLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <a href="#" class="btn-close" data-dismiss="modal" data-target="#tnc" aria-label="Close"></a>
                <h2 class="modal-title" id="demoLabel">{{ tncContent.pageTitle }}</h2>
                <div class="modal-body">
                    <div class="tnc-popup">
                        {# Content Start from Cms  #}
                        {% for content in tncContent.cmsPageContent %}
                            <p>
                                {% include 'portal/page/_page_content_display.html.twig' %}
                            </p>
                        {% endfor %}
                        {# Content End from Cms  #}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <section class="banner-sec">
        {{ include('portal/project-details/_create_project_header.html.twig') }}
    </section>
    <div class="wrapper">
        <div class="container">
            <div class="row">
                <div class="start-project col-lg order-lg-2" id="start-project">
                    <div class="head-sec">
                        <h2>Start Your Project Now</h2>
                        <div class="tips-button">
                            <a href="{{ path('create-project-tip') }}"><i class="tips-icon"></i> Tips for Project Creation</a>
                        </div>
                    </div>
                    <ul class="steps">
                        <li class="completed">
                            <span class="num"></span>
                            Interest Area
                        </li>
                        <li class="completed">
                            <span class="num"></span>
                            Project Details
                        </li>
                        <li class="active">
                            <span class="num"></span>
                            Gallery
                        </li>
                    </ul>
                    <div class="project-details gallery">
                        <form enctype="multipart/form-data" method="post" id="frmProjectGallery" name="frmProjectGallery">
                            <input type="hidden" name="token" value="{{ csrf_token('upload') }}" />
                            <div class="mandate-text"><span>*</span> Mandatory Fields </div>
                            <div class="row justify-content-center">
                                <div class="col-sm-12">
                                    <div class="main-form-group">
                                        <i class="icon project-name"><img
                                                    src="/resources/images/common/create-project/Icon-UploadImage.png"
                                                    alt=""></i>
                                        <label for="projectType">
                                            <span>Upload Image *</span>
                                            <div class="tooltip">
                                                <i class="fas fa-info-circle"></i>
                                                <span class="tooltiptext">Select images to display in your Project Gallery.</span>
                                            </div>
                                        </label>
                                        <ul class="project-status">
                                            {# <li class="project-status-input gc-gallery">
                                                <i class="fc-gc-logo"></i>
                                                <span>Giving Circle Gallery</span>
                                            </li>#}
                                            <li class="project-status-input my-gallery">
                                                <i class="fa fa-user-o"></i>
                                                <span>My Gallery</span>
                                            </li>
                                        </ul>
                                        <div class="gc-gallery-div">
                                            <div class="row">
                                                <div class="col-auto">
                                                    <div class="input-field">
                                                        <label class="active">Project Profile Image</label>
                                                        <div class="profile-image single" data-toggle="modal"
                                                             data-target="#gc-gallery-modal1">
                                                            <div class="image-uploader">
                                                                <div class="uploaded"></div>
                                                                <div class="upload-text">
                                                                    <i class="fc-gallery-icon"></i>
                                                                    <span>Upload Profile Image</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <small>Image format - <br> jpg, png and size 5 MB</small>
                                                    </div>
                                                </div>
                                                <div class="col">
                                                    <div class="input-field">
                                                        <label class="active">Project Background Image</label>
                                                        <div class="input-images single" data-toggle="modal"
                                                             data-target="#gc-gallery-modal1">
                                                            <div class="image-uploader">
                                                                <div class="uploaded"></div>
                                                                <div class="upload-text">
                                                                    <i class="fc-gallery-icon"></i>
                                                                    <span>Upload Background Image</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <small>Image format - jpg, png and size 5 MB</small>
                                                    </div>
                                                </div>
                                                <div class="col-12">
                                                    <div class="input-field">
                                                        <label class="active">Project Gallery</label>
                                                        <div class="input-images single" data-toggle="modal"
                                                             data-target="#gc-gallery-modal1">
                                                            <div class="image-uploader">
                                                                <div class="uploaded"></div>
                                                                <div class="upload-text">
                                                                    <i class="fc-gallery-icon"></i>
                                                                    <span>Upload Gallery Images</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <small>Image format - jpgs, png and size 5 MB</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="my-gallery-div">
                                            <div class="row">
                                                <div class="col-auto">
                                                    <div class="input-field">
                                                        <label class="active">Project Profile Image</label>
                                                        <div class="input-images-1 single"></div>
                                                        <small>Image format - <br> jpg, png and size 5 MB</small>
                                                    </div>
                                                </div>
                                                <div class="col">
                                                    <div class="input-field">
                                                        <label class="active">Project Background Image</label>
                                                        <div class="input-images-2 single"></div>
                                                        <small>Image format - jpg, png and size 5 MB</small>
                                                    </div>
                                                </div>
                                                <div class="col-12">
                                                    <div class="input-field">
                                                        <label class="active">Project Gallery</label>
                                                        <div class="input-images-3 multi"></div>
                                                        <small>Image format - jpgs, png and size 5 MB</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-sm-12">
                                    <div class="main-form-group">
                                        <i class="icon project-name"><img
                                                    src="/resources/images/common/create-project/Icon-YouTube.png"
                                                    alt=""></i>
                                        <label for="youTube">YouTube Video Link</label>
                                        <div class="youTube-form">
                                            {% if arrUrl|length > 0 %}
                                                {% set i = 0 %}
                                                {% for url in arrUrl %}
                                                    {% set i = i+1 %}
                                                <div {% if i != arrUrl|length %}class="old"{% endif %}>
                                                    <input type="text" name="youtube[]" class="form-control" id="youTube"
                                                           placeholder="e.g. Link to a video about your project" value="{{ url }}">
                                                    <a href="#" class="removeInput"><i class="fa fa-minus-circle"></i></a>
                                                </div>
                                                    <small>Enter the embed url for the youtube video to play. The embed url can be found once the embed code copied on a document.</small>
                                                {% endfor %}
                                            {% else %}
                                                <div>
                                                    <input type="text" name="youtube[]" class="form-control" id="youTube"
                                                           placeholder="e.g. Link to a video about your project">
                                                    <a href="#" class="removeInput"><i class="fa fa-minus-circle"></i></a>
                                                </div>
                                                <small>Enter the embed url for the youtube video to play. The embed url can be found once the embed code copied on a document.</small>
                                            {% endif %}

                                            <a href="#" class="add-more" id="addMore"><i class="fa fa-plus-circle"></i>
                                                Add More</a>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <label class="checkbox-label" for="tnc">
                                        I agree to <a href="#" data-toggle="modal" data-target="#tncpopup">Terms &
                                            Conditions</a>
                                        <input type="checkbox" id="tnc">
                                        <span class="checkmark"></span>
                                    </label>
                                </div>
                            </div>
                            <div class="btn-sec" data-aos="fade-right" data-aos-delay="200">

                                <input type="hidden" name="submission_type" id="submission_type" value="review">

                                <a href="javascript:void(0);" class="back-link">Back</a>
                                <a href="javascript:void(0);" class="btn btn-primary-o btn-continue" id="review">Review Your Project</a>
                                <a href="javascript:void(0);" class="btn btn-primary btn-continue" id="submit">Submit Your Project</a>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="feature-section col-lg order-lg-1">
                    <h4 data-aos="fade-right" data-aos-delay="200">{{ pageContentHeader.cmsPageContent[2].pageContent|raw }}</h4>

                    {% set iconList = {'0' : '<i class="fc-inspiration"></i> ' , '1' : '<i class="fc-spread"></i> ',
                        '2' : '<i class="fc-generate"></i> ', '3' : '<i class="fc-plan"></i> ', '4' : '<i class="fc-share"></i> '} %}

                    {% set liList = pageContentHeader.cmsPageContent[3].pageContent %}
                    {% set liList = liList|split('</li>') %}
                    {% set newLiList = [] %} {# defualt to original value #}
                    {% for listitems in liList %}
                        {% set iconkey = loop.index0 %}
                        {% if iconList[iconkey] is defined %}
                            {% set newLiVal = listitems|replace({'<li>' : '<li>'~iconList[iconkey]}) %}
                        {% else %}
                            {% set newLiVal = listitems|replace({'<li>' : '<li><i class="fc-inspiration"></i>'}) %}
                        {% endif %}
                        {% set newLiList = newLiList|merge([newLiVal]) %}
                    {% endfor %}
                    <div class="feature-list" data-aos="fade-right" data-aos-delay="200">
                        {{ newLiList|join('</li>')|raw }}
                    </div>

                    <figure>
                        <img src="/resources/images/common/create-project/features-image.png" alt="">
                    </figure>

                    <div class="view-project-button">
                        <div class="demo-text">
                            {{ pageContentHeader.cmsPageContent[4].pageContent|raw }}
                            <a href="#" data-toggle="modal" data-target="#demoModal">View Now</a>
                        </div>
                    </div>

                    {#<div class="view-project-button">
                        <a href="#" data-toggle="modal" data-target="#demoModal">
                            View Project Creation Demo
                            {{ pageContentHeader.cmsPageContent[2].pageContent|raw }}
                        </a>
                    </div>#}
                </div>
            </div>
        </div>
    </div>
    {{ render(controller('App\\Controller\\Portal\\ProjectController::galleryPopUp')) }}
    {{ include('portal/project-details/_project_demo.html.twig') }}
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="{{ asset('resources/js/image-uploader.min.js') }}"></script>
    <script>
        var bHasProfileImage = false;
        var profilePic = backgroundImage = "";
        var preloadedProfile = new Array();
        var preloadedBackGround = new Array();
        var preloadedGallery = new Array();
        {% if arrImages is defined and 'profile' in arrImages|keys and arrImages['profile'] is not empty and
            arrImages['profile'] is
            defined %}
            profilePic = "{{ asset('images') }}/{{ arrImages['profile'] }}";
            bHasProfileImage = true;
            preloadedProfile = [ {id: 1, src: profilePic} ];
        {% endif %}
        {% if arrImages is defined  and 'backgroundImage' in arrImages|keys and  arrImages['backgroundImage'] is not empty and arrImages['backgroundImage'] is
            defined %}
            backgroundImage = "{{ asset('images') }}/{{ arrImages['backgroundImage'] }}";
            bHasProfileImage = true;
            preloadedBackGround = [ {id: 1, src: backgroundImage} ];
        {% endif %}
        var imageGallery = new Array();
        {% set i = 1 %}
        {% if arrImages is defined and 'imageGallery' in arrImages|keys and arrImages['imageGallery'] is not empty and
            arrImages['imageGallery'] is
            defined %}
            {% for id in arrImages['imageGallery'] %}
                imageGallery.push("{{ id }}");
                bHasProfileImage = true;
                var item = {};
                item.id = "{{ i }}";
                item.src = "{{ asset('images') }}/{{ id }}";
                preloadedGallery.push(item);
                {% set i = i + 1 %}
            {% endfor %}
        {% endif %}
        $(document).ready(function () {

            $(".delete-image").on('click', function (){

                var imgFldNme = $(this).siblings('input').attr('name');
                var imgSrc = $(this).siblings('input').val();

                if(imgFldNme == 'preloadedGalImg[]') {
                    // remove gallery image

                    var data = {};
                    data['imagetype'] = 'galleryimage';
                    data['imgsrc'] = imgSrc;

                    jQuery.ajax({
                        url: "{{ path('remove_image') }}",
                        data: data,
                        type: "GET",
                        dataType: "JSON",
                        success: function (data) {
                            console.log(data);
                        }
                    });
                }
            });

            $('body').addClass('inner-pg');
            $('body').addClass('create-element');
            $('body').addClass('logged');
            $('html, body').animate(
                {
                    scrollTop: $($('.next-section-arrow').attr('href')).offset().top - 95,
                },
                800,
                'linear'
            );

            var galimgurlsarr = [];

            $.each(preloadedGallery, function (){

                // console.log($(this).get(0).src);
                galimgurlsarr.push($(this).get(0).src);
            });
            // $('input[name="imageGallery[][]"]').val([galimgurlsarr]);

            $('.btn-continue').click(function (){

                if ($("#tnc").prop("checked") == false){
                    alert('Please check Terms & Conditions.');
                    $("#tnc").focus();
                    return false;
                }

                var errormsg =  '';
                var error =  false;

                var youtubeUrlArr = [];
                var duplicate = [];
                // youtube url duplication check
                $('input[name="youtube[]"]').each(function( index ) {

                    if($( this ).val() != '') {
                        youtubeUrlArr[index]  = $( this ).val();
                        var sortedArr = youtubeUrlArr.sort();

                        for (var i = 0; i < sortedArr.length - 1; i++) {
                            if (sortedArr[i + 1] == sortedArr[i]) {
                                duplicate.push(sortedArr[i]);
                                error = true;
                            }
                        }
                    }
                });

                if(error === true) {
                    errormsg+="Duplicate URLs entered\n";
                }

                var validExtensions = ['jpg', 'jpeg','png']; //array of valid extensions
                var profileImgFileSize = 5248000 // 5.1MB //20000 - 20KB
                var backgroundImgFileSize = 5248000 // 5.1MB //40000 - 40KB
                var galleryImgFileSize = 5248000 // 5.1MB //60000 - 60KB

                var bPreloadedProfileImg = true;
                var bPreloadedBgImg = true;
                var bPreloadedGalleryImg = true;

                if($('input[name="preloadedProfileImg[]"]') == undefined || $('input[name="preloadedProfileImg[]"]').val() == undefined) {
                    bPreloadedProfileImg = false;
                }
                if($('input[name="preloadedBgImg[]"]') == undefined || $('input[name="preloadedBgImg[]"]').val() == undefined) {
                    bPreloadedBgImg = false;
                }
                if($('input[name="preloadedGalImg[]"]') == undefined || $('input[name="preloadedGalImg[]"]').val() == undefined) {
                    bPreloadedGalleryImg = false;
                }

                $('input[name="profileImage[]"]').each(function() {

                    if($(this)[0].files[0] == undefined && bPreloadedProfileImg === false) {
                        errormsg+="Please upload profile image\n";
                        error = true;
                    } else if($(this)[0].files[0] != undefined) {
                        var fileName = $(this)[0].files[0].name;

                        if ($(this).val() == '' || fileName == undefined) {
                            errormsg += "Please upload profile image\n";
                            error = true;
                        } /*else if (fileName != undefined) {

                            var fileNameExt = fileName.substr(fileName.lastIndexOf('.') + 1);
                            if ($.inArray(fileNameExt, validExtensions) == -1) {
                                errormsg += "Profile image: Invalid file type\n";
                                error = true;
                            } else if ($(this)[0].files[0].size > profileImgFileSize) {
                                // file size error Profile image 20KB
                                errormsg += "Profile image: Size more than 20KB\n";
                                error = true;
                            }
                        }
                        */
                    }
                });

                $('input[name="backGroundImage[]"]').each(function() {

                    if($(this)[0].files[0] == undefined && bPreloadedBgImg === false) {
                        errormsg+="Please upload background image\n";
                        error = true;
                    } else if($(this)[0].files[0] != undefined) {
                        var fileName = $(this)[0].files[0].name;

                        if ($(this).val() == '' || fileName == undefined) {
                            errormsg += "Please upload background image\n";
                            error = true;
                        } /*else if (fileName != undefined) {

                            var fileNameExt = fileName.substr(fileName.lastIndexOf('.') + 1);
                            if ($.inArray(fileNameExt, validExtensions) == -1) {
                                errormsg += "Background image: Invalid file type\n";
                                error = true;
                            } else if ($(this)[0].files[0].size > backgroundImgFileSize) {
                                // file size error Background image 40KB
                                errormsg += "Background image: Size more than 40KB\n";
                                error = true;
                            }
                        }*/
                    }
                });

                $('input[name="imageGallery[][]"]').each(function() {

                    if($(this)[0].files[0] == undefined && bPreloadedGalleryImg === false) {
                        errormsg+="Please upload atleast one gallery image\n";
                        error = true;
                    } else if($(this)[0].files[0] != undefined) {
                        var fileName = $(this)[0].files[0].name;

                        if ($(this).val() == '' || fileName == undefined) {
                            errormsg += "Please upload atleast one gallery image\n";
                            error = true;
                        } /*else if (fileName != undefined) {

                            var fileNameExt = fileName.substr(fileName.lastIndexOf('.') + 1);
                            if ($.inArray(fileNameExt, validExtensions) == -1) {
                                errormsg += "Gallery image: Invalid file type\n";
                                error = true;
                            } else if ($(this)[0].files[0].size > galleryImgFileSize) {
                                // file size error Gallery image 60KB
                                errormsg += "Gallery image: Size more than 60KB\n";
                                error = true;
                            }
                        }*/
                    }
                });
                // error = false;
                if(error === true) {
                    alert(errormsg);
                    return false;
                } else {

                    // set submission_type based of clicked button: review or submit
                    $("#submission_type").val($(this).attr('id'));
                    $("#frmProjectGallery").submit();
                }
            });
            $(window).scroll(function () {
                if ($(this).scrollTop() > 150) {
                    $('.bullets .first').removeClass('active');
                    $('.bullets .second').addClass('active');
                } else {
                    $('.banner-sec').removeClass('fixed');
                    $('.wrapper').removeClass('fixed');
                    $('.bullets .first').addClass('active');
                    $('.bullets .second').removeClass('active');
                }
            });
            $('.next-section-arrow').on('click', function (e) {
                e.preventDefault()
                $('html, body').animate(
                    {
                        scrollTop: $($(this).attr('href')).offset().top - 95,
                    },
                    800,
                    'linear'
                );
            });
            $('.bullets li.second > a').on('click', function (e) {
                e.preventDefault()
                $('html, body').animate(
                    {
                        scrollTop: $($(this).attr('href')).offset().top - 95,
                    },
                    800,
                    'linear'
                );
                $(this).parent('li').addClass('active');
                $(this).parent('li').siblings('li').removeClass('active');
            });
            function formcontrol() {
                $(".form-control").filter(function () {
                    if (this.value.length !== 0) {
                        $(this).siblings('label').addClass('clicked');
                    }
                });
            }
            formcontrol();
            $('.form-group label').click(function () {
                $(this).addClass('clicked');
            });
            $('.form-control').click(function () {
                $(this).siblings('label').addClass('clicked');
            });
            $('.form-control').keyup(function () {
                $(this).siblings('label').addClass('clicked');
            });
            $('.form-control').blur(function () {
                if ($(this).val()) {
                    $(this).siblings('label').addClass('clicked');
                } else if (!$(this).val()) {
                    $(this).siblings('label').removeClass('clicked');
                }
            });
            $('.form-group select').change(function () {
                if (this.value.length !== 0) {
                    $(this).parent().parent().find('label').addClass('clicked');
                } else {
                    $(this).parent().parent().find('label').removeClass('clicked');
                }
            });

            $('.project-status-input').click(function () {
                $(this).addClass('clicked');
                $(this).siblings().removeClass('clicked');
            });

            $('.edit-link').click(function () {
                $(this).siblings('input').prop("readonly", false).focus();
            });

            $(document).on('click', '#addMore', function (e) {
                e.preventDefault();
                var newinput = $('.youTube-form div:last').clone();
                $('.youTube-form div:last').addClass('old');
                newinput.find("input").val("");
                $(newinput).insertAfter(".youTube-form div:last");
                // $('.youTube-form div:last').find(':input').val('');
            });

            $(document).on('click', '.removeInput', function (e) {
                if ($('.removeInput').length == 1) {
                    return false;
                }
                e.preventDefault();
                $(this).closest('div').remove();
            });
            checkValidFileExtension = function () {
            };
            $(document).on('change', '#primaryAI', function (e) {
                if(typeof arrPrimaryAISecAIMap[$(this).val()] === 'undefined') {}
                else {
                    $("#secondaryAI").attr('disabled', false);
                    var product = $("#secondaryAI");
                    product.html('');
                    product.append('<option value="" >Sub - Interest Area</option>');
                    for (x in arrPrimaryAISecAIMap[$(this).val()]){
                        product.append('<option value="'+ x +'">'+ arrPrimaryAISecAIMap[$(this).val()][x] + '</option>');
                    }
                }
            });
            if (bHasProfileImage == true) {
                $(".my-gallery").click();
            }
        });
        $('.gc-gallery').click(function () {
            $(this).parents('.project-status').siblings('.gc-gallery-div').show();
            $(this).parents('.project-status').siblings('.my-gallery-div').hide();
            $(this).addClass('clicked');
            $(this).siblings().removeClass('clicked');
        });
        $('.my-gallery').click(function () {
            $(this).parents('.project-status').siblings('.my-gallery-div').show();
            $(this).parents('.project-status').siblings('.gc-gallery-div').hide();
            $(this).addClass('clicked');
            $(this).siblings().removeClass('clicked');
        });
        $('.input-images-1').imageUploader({
            label: 'Upload Profile Image',
            imagesInputName: 'profileImage',
            extensions: ['.jpg', '.jpeg', '.png'],
            mimes: ['image/jpeg', 'image/png'],
            maxSize: 5248000, // 5.1MB
            preloaded: preloadedProfile,
            preloadedInputName: 'preloadedProfileImg'
        });
        $('.input-images-2').imageUploader({
            label: 'Upload Background Image',
            imagesInputName: 'backGroundImage',
            extensions: ['.jpg', '.jpeg', '.png'],
            mimes: ['image/jpeg', 'image/png'],
            maxSize: 5248000, // 5.1MB
            preloaded: preloadedBackGround,
            preloadedInputName: 'preloadedBgImg'
        });
        $('.input-images-3').imageUploader({
            label: 'Upload Gallery Images',
            label2: 'Add More Images',
            imagesInputName: 'imageGallery[]',
            extensions: ['.jpg', '.jpeg', '.png'],
            mimes: ['image/jpeg', 'image/png'],
            maxSize: 5248000, // 5.1MB
            preloaded: preloadedGallery,
            preloadedInputName: 'preloadedGalImg'
        });

    </script>
{% endblock %}